<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<title>Balanced News ‚Äì Analys</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <nav class="tabs">
    <a href="/" class="{{ 'on' if current_site=='all' else '' }}">Alla</a>
    {% for slug, meta in sites.items() %}
      <a href="/site/{{ slug }}"
         class="{{ 'on' if current_site==slug else '' }}">{{ meta.name }}</a>
    {% endfor %}
    <a href="/analytics" class="right">Analys&nbsp;üìà</a>
  </nav>

  <h1>Kvalitetsanalys</h1>
  <p class="tagline">√ñversikt av nyhetskvalitet och verifiering per k√§lla</p>
  
  <div class="header-actions">
    <form class="search-form" action="{{ url_for('analytics') }}" method="get">
      <input type="search" name="q" value="{{ search_query }}" placeholder="Filtrera analyser..." required>
      <button type="submit">S√∂k</button>
    </form>
  </div>
</header>

<main style="max-width:900px;margin:0 auto;padding:0 1rem 4rem;">
  <canvas id="verificationChart" height="280" style="display:none;"></canvas>
  <p id="nodata" style="text-align:center;color:#666;margin:4rem 0;">Ingen analysdata tillg√§nglig √§n. 
     Analysera minst en artikel f√∂r att se diagrammet.</p>

  <div id="metrics" style="display:none;margin-top:2rem;">
    <h2>Detaljerad analys per k√§lla</h2>
    <div class="metrics-grid">
      {% for slug, meta in sites.items() %}
        {% if slug in verification_data.metrics %}
        <div class="metric-card" data-site="{{ slug }}">
          <h3>{{ meta.name }}</h3>
          <div class="metric-content">
            <p><strong>Analyserade artiklar:</strong> {{ verification_data.metrics[slug].total_articles }}</p>
            <p><strong>Verifierade p√•st√•enden:</strong> {{ verification_data.metrics[slug].verified }}</p>
            <p><strong>Korrigerade p√•st√•enden:</strong> {{ verification_data.metrics[slug].corrected }}</p>
            <div class="quality-scores">
              <div class="score-item">
                <h4>Objektivitet</h4>
                <div class="score-bar">
                  <div class="score-fill objectivity-score"></div>
                </div>
                <span class="score-value">{{ verification_data.metrics[slug].avg_objectivity }}%</span>
              </div>
              <div class="score-item">
                <h4>Djup</h4>
                <div class="score-bar">
                  <div class="score-fill depth-score"></div>
                </div>
                <span class="score-value">{{ verification_data.metrics[slug].avg_depth }}%</span>
              </div>
              <div class="score-item">
                <h4>Bevis</h4>
                <div class="score-bar">
                  <div class="score-fill evidence-score"></div>
                </div>
                <span class="score-value">{{ verification_data.metrics[slug].avg_evidence }}%</span>
              </div>
              <div class="score-item">
                <h4>Tydlighet</h4>
                <div class="score-bar">
                  <div class="score-fill clarity-score"></div>
                </div>
                <span class="score-value">{{ verification_data.metrics[slug].avg_clarity }}%</span>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <h2 style="margin-top:3rem;">√Öterst√§ll data</h2>
  <button id="resetBtn">√Öterst√§ll all analysdata</button>
</main>

<footer>
  <small>Uppdaterad {{ now.strftime("%Y-%m-%d %H:%M UTC") }}</small>
</footer>

<!-- JSON payload rendered by Flask -->
<script id="verification-data" type="application/json">{{ verification_data|tojson }}</script>

<script>
  // Parse the payload
  const payload = JSON.parse(document.getElementById('verification-data').textContent);
  const { labels=[], verified=[], corrected=[], metrics={} } = payload || {};

  if (labels.length) {
    // we have data ‚Äì hide message & show charts
    document.getElementById('nodata').style.display = 'none';
    document.getElementById('verificationChart').style.display = 'block';
    document.getElementById('metrics').style.display = 'block';

    // Set score bar widths using CSS variables
    Object.entries(metrics).forEach(([slug, data]) => {
      const card = document.querySelector(`.metric-card[data-site="${slug}"]`);
      if (card) {
        card.style.setProperty('--objectivity-score', `${data.avg_objectivity}%`);
        card.style.setProperty('--depth-score', `${data.avg_depth}%`);
        card.style.setProperty('--evidence-score', `${data.avg_evidence}%`);
        card.style.setProperty('--clarity-score', `${data.avg_clarity}%`);
      }
    });

    new Chart(document.getElementById('verificationChart'), {
      type: 'bar',
      data: {
        labels,
        datasets:[
          { 
            label: 'Verifierade p√•st√•enden',
            data: verified,
            backgroundColor: '#4CAF50'
          },
          {
            label: 'Korrigerade p√•st√•enden',
            data: corrected,
            backgroundColor: '#FFC107'
          }
        ]
      },
      options: {
        scales: { 
          y: { 
            beginAtZero: true,
            grid: { color: '#ccc' },
            title: {
              display: true,
              text: 'Antal p√•st√•enden'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Nyhetsk√§lla'
            }
          }
        },
        plugins: {
          legend: { 
            display: true,
            position: 'top'
          },
          tooltip: {
            callbacks: {
              label: (c) => `${c.dataset.label}: ${c.parsed.y}`
            }
          },
          title: {
            display: true,
            text: 'Verifiering av p√•st√•enden per nyhetsk√§lla',
            font: {
              size: 16
            }
          }
        }
      }
    });
  }

  // dev-only reset button
  document.getElementById('resetBtn').onclick = async ()=>{
    if(!confirm('√Ñr du s√§ker p√• att du vill ta bort all analysdata?')) return;
    await fetch('/reset-analytics', {method:'POST'});
    location.reload();
  };
</script>

<style>
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  margin-top: 1rem;
}

.metric-card {
  background: white;
  border-radius: 8px;
  padding: 1.5rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-card h3 {
  margin-top: 0;
  color: #2c3e50;
  border-bottom: 2px solid #eee;
  padding-bottom: 0.5rem;
}

.metric-content {
  margin-top: 1rem;
}

.metric-content p {
  margin: 0.5rem 0;
  color: #666;
}

.metric-content strong {
  color: #333;
}

.quality-scores {
  margin-top: 1.5rem;
}

.score-item {
  margin-bottom: 1rem;
}

.score-item h4 {
  margin: 0 0 0.5rem;
  font-size: 0.9rem;
  color: #666;
}

.score-bar {
  height: 8px;
  background: #eee;
  border-radius: 4px;
  overflow: hidden;
}

.score-fill {
  height: 100%;
  background: #0066cc;
  border-radius: 4px;
  transition: width 0.3s ease;
}

.objectivity-score { width: var(--objectivity-score, 0%); }
.depth-score { width: var(--depth-score, 0%); }
.evidence-score { width: var(--evidence-score, 0%); }
.clarity-score { width: var(--clarity-score, 0%); }

.score-value {
  font-size: 0.8rem;
  color: #666;
  text-align: right;
  display: block;
  margin-top: 0.2rem;
}
</style>
</body>
</html>
