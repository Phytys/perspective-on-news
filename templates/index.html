<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Perspektiv p√• nyheter</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<header>
  <nav class="tabs">
    <a href="/" class="{{ 'on' if current_site=='all' else '' }}">Alla</a>
    {% for slug, meta in sites.items() %}
      <a href="/site/{{ slug }}"
         class="{{ 'on' if current_site==slug else '' }}">{{ meta.name }}</a>
    {% endfor %}
    <a href="/analytics" class="right">Analys&nbsp;üìà</a>
    <a href="/about" class="right">Om</a>
  </nav>  
  
  <h1>Perspektiv p√• nyheter</h1>
  <p class="tagline">Se nyheten ‚Äî och sammanhanget.</p>
  
  <div class="header-actions">
    <form class="search-form" action="{{ url_for('index_all' if current_site=='all' else 'index_site', site=current_site) }}" method="get">
      <input type="search" name="q" value="{{ search_query }}" placeholder="S√∂k i nyheter..." required>
      <button type="submit">S√∂k</button>
    </form>
  </div>
  
  <div class="update-news">
    <button id="fetchNewsBtn" class="check">Uppdatera nyhetsfl√∂det</button>
    {% if config.FLASK_ENV == 'development' %}
    <button id="resetAllBtn" class="check" style="background: #dc3545;">Rensa alla nyheter</button>
    {% endif %}
  </div>
</header>

<main>
{% for art in articles %}
  <article class="card">
    <h2>{{ art.title }}</h2>
    {% if art.summary %}<p>{{ art.summary }}</p>{% endif %}
    <p><a href="{{ art.url }}" target="_blank" rel="noopener">L√§s hos {{ art.site.title() }}</a></p>
    <p class="article-meta">
      <span class="fetch-date">Publicerad: {{ art.fetched_at.strftime('%Y-%m-%d %H:%M') }} UTC</span>
    </p>

    {% if art.nuanced_perspective %}
      <hr>
      <div class="analysis-header">
        <h3>Nyanserad bild</h3>
        <button class="toggle-analysis" onclick="toggleAnalysis(this)">Visa analys</button>
      </div>
      <p class="analysis-note">Analys baserad p√• rubrik och sammanfattning</p>
      <div class="analysis-scope">
        <p class="scope-warning">‚ö†Ô∏è Denna analys baseras endast p√• artikelns rubrik och sammanfattning, inte hela artikeln.</p>
        <p class="scope-cta">F√∂r en komplett bild och svar p√• eventuella fr√•getecken, rekommenderar vi att du l√§ser hela artikeln hos {{ art.site.title() }}.</p>
      </div>
      {% set analysis = art.nuanced_perspective|from_json %}
      <div class="analysis collapsed">
        {% if analysis.model_used %}
        <div class="model-info">
          <span class="model-badge">Analysmodell: {{ analysis.model_used }}</span>
        </div>
        {% endif %}
        {% if analysis.main_facts %}
        <h4>Huvudfakta</h4>
        <p>{{ analysis.main_facts }}</p>
        {% endif %}
        
        {% if analysis.historical_context %}
        <div class="historical-context">
          <h4>Historisk kontext</h4>
          {% if analysis.historical_context.background %}
          <div class="context-section">
            <h5>Bakgrund</h5>
            <p>{{ analysis.historical_context.background }}</p>
          </div>
          {% endif %}
          
          {% if analysis.historical_context.key_events %}
          <div class="context-section">
            <h5>Viktiga h√§ndelser</h5>
            <ul>
              {% for event in analysis.historical_context.key_events %}
                <li>{{ event }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
          
          {% if analysis.historical_context.structural_trends %}
          <div class="context-section">
            <h5>Strukturella trender</h5>
            <ul>
              {% for trend in analysis.historical_context.structural_trends %}
                <li>{{ trend }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>
        {% endif %}
        
        {% if analysis.key_arguments %}
        <h4>Nyckelargument</h4>
        <div class="arguments-sections">
          {% if analysis.key_arguments.primary %}
          <div class="argument-section primary">
            <h5>Huvudargument</h5>
            <p>{{ analysis.key_arguments.primary }}</p>
          </div>
          {% endif %}
          
          {% if analysis.key_arguments.counter %}
          <div class="argument-section counter">
            <h5>Motargument</h5>
            <p>{{ analysis.key_arguments.counter }}</p>
          </div>
          {% endif %}
          
          {% if analysis.key_arguments.evidence %}
          <div class="argument-section evidence">
            <h5>Bevis och st√∂d</h5>
            <ul>
              {% for evidence in analysis.key_arguments.evidence %}
                <li>{{ evidence }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>
        {% endif %}
        
        {% if analysis.implications %}
        <h4>Konsekvenser</h4>
        <div class="implication-sections">
          {% if analysis.implications.immediate %}
          <div class="implication-section">
            <h5>Direkta konsekvenser</h5>
            <p>{{ analysis.implications.immediate }}</p>
          </div>
          {% endif %}
          
          {% if analysis.implications.long_term %}
          <div class="implication-section">
            <h5>L√•ngsiktiga konsekvenser</h5>
            <p>{{ analysis.implications.long_term }}</p>
          </div>
          {% endif %}
        </div>
        {% endif %}
        
        {% if analysis.content_type %}
        <div class="analysis-meta">
          {% if analysis.content_type %}
          <p><strong>Inneh√•llstyp:</strong> {{ analysis.content_type }}</p>
          {% endif %}
          {% if art.analyzed_at %}
          <p>Analyserad: {{ art.analyzed_at.strftime('%Y-%m-%d %H:%M') }} UTC</p>
          {% endif %}
          {% if art.last_updated_at and art.last_updated_at != art.analyzed_at %}
          <p>Senast uppdaterad: {{ art.last_updated_at.strftime('%Y-%m-%d %H:%M') }} UTC</p>
          {% endif %}
        </div>
        {% endif %}

        {% if art.verified_claims > 0 or art.corrected_claims > 0 %}
        <div class="analysis-section">
            <h3>Verifieringssammanfattning</h3>
            <div class="analysis-content">
                {% if art.verified_claims > 0 %}
                <div class="analysis-item">
                    <h4>Verifierade p√•st√•enden</h4>
                    <p>{{ art.verified_claims }} p√•st√•enden verifierades</p>
                </div>
                {% endif %}
                {% if art.corrected_claims > 0 %}
                <div class="analysis-item">
                    <h4>Korrigerade p√•st√•enden</h4>
                    <p>{{ art.corrected_claims }} p√•st√•enden korrigerades</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if analysis.bias_analysis %}
        <div class="analysis-section">
            <h3>Biasanalys</h3>
            <div class="analysis-content">
                {% if analysis.bias_analysis.political_leaning %}
                <div class="analysis-item">
                    <h4>Politiskt perspektiv</h4>
                    <p>{{ analysis.bias_analysis.political_leaning }}</p>
                </div>
                {% endif %}
                {% if analysis.bias_analysis.framing_analysis %}
                <div class="analysis-item">
                    <h4>Inramning</h4>
                    <p>{{ analysis.bias_analysis.framing_analysis }}</p>
                </div>
                {% endif %}
                {% if analysis.bias_analysis.language_analysis %}
                <div class="analysis-item">
                    <h4>Spr√•kanalys</h4>
                    <p>{{ analysis.bias_analysis.language_analysis }}</p>
                </div>
                {% endif %}
                {% if analysis.bias_analysis.source_analysis %}
                <div class="analysis-item">
                    <h4>K√§llanalys</h4>
                    <p>{{ analysis.bias_analysis.source_analysis }}</p>
                </div>
                {% endif %}
                {% if analysis.bias_analysis.omission_analysis %}
                <div class="analysis-item">
                    <h4>Analys av utel√§mnanden</h4>
                    <p>{{ analysis.bias_analysis.omission_analysis }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if analysis.balanced_perspective %}
        <div class="analysis-section">
            <h3>Balanserat perspektiv</h3>
            <div class="analysis-content">
                {% if analysis.balanced_perspective.missing_viewpoints %}
                <div class="analysis-item">
                    <h4>Saknade synvinklar</h4>
                    <p>{{ analysis.balanced_perspective.missing_viewpoints }}</p>
                </div>
                {% endif %}
                {% if analysis.balanced_perspective.additional_context %}
                <div class="analysis-item">
                    <h4>Ytterligare kontext</h4>
                    <p>{{ analysis.balanced_perspective.additional_context }}</p>
                </div>
                {% endif %}
                {% if analysis.balanced_perspective.improvement_suggestions %}
                <div class="analysis-item">
                    <h4>F√∂rb√§ttringsf√∂rslag</h4>
                    <p>{{ analysis.balanced_perspective.improvement_suggestions }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if analysis.factual_accuracy %}
        <div class="analysis-section">
            <h3>Faktakorrekthet</h3>
            <div class="analysis-content">
                {% if analysis.factual_accuracy.claim_verification %}
                <div class="analysis-item">
                    <h4>Verifiering av p√•st√•enden</h4>
                    <div class="confidence-levels">
                        <div class="confidence-item high">
                            <span class="confidence-label">H√∂g konfidens</span>
                            <span class="confidence-desc">P√•st√•endet kan verifieras med s√§kerhet</span>
                        </div>
                        <div class="confidence-item medium">
                            <span class="confidence-label">Medel konfidens</span>
                            <span class="confidence-desc">P√•st√•endet kan delvis verifieras</span>
                        </div>
                        <div class="confidence-item low">
                            <span class="confidence-label">L√•g konfidens</span>
                            <span class="confidence-desc">Otillr√§cklig information f√∂r verifiering</span>
                        </div>
                    </div>
                    <p>{{ analysis.factual_accuracy.claim_verification }}</p>
                </div>
                {% endif %}
                {% if analysis.factual_accuracy.unsupported_assertions %}
                <div class="analysis-item">
                    <h4>Obekr√§ftade p√•st√•enden</h4>
                    <p>{{ analysis.factual_accuracy.unsupported_assertions }}</p>
                </div>
                {% endif %}
                {% if analysis.factual_accuracy.logical_fallacies %}
                <div class="analysis-item">
                    <h4>Logiska felslut</h4>
                    <p>{{ analysis.factual_accuracy.logical_fallacies }}</p>
                </div>
                {% endif %}
                {% if analysis.factual_accuracy.source_credibility %}
                <div class="analysis-item">
                    <h4>K√§lltillf√∂rlitlighet</h4>
                    <p>{{ analysis.factual_accuracy.source_credibility }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if analysis.reporting_quality %}
        <div class="analysis-section">
            <h3>Rapporteringskvalitet</h3>
            <div class="analysis-content">
                <div class="quality-scores">
                    {% if analysis.reporting_quality.objectivity_score is not none %}
                    <div class="score-item">
                        <h4>Objektivitet</h4>
                        <div class="score-bar">
                            <div class="score-fill objectivity-score"></div>
                        </div>
                        <span class="score-value">{{ "%.1f"|format(analysis.reporting_quality.objectivity_score) }}%</span>
                    </div>
                    {% endif %}
                    {% if analysis.reporting_quality.depth_score is not none %}
                    <div class="score-item">
                        <h4>Djup</h4>
                        <div class="score-bar">
                            <div class="score-fill depth-score"></div>
                        </div>
                        <span class="score-value">{{ "%.1f"|format(analysis.reporting_quality.depth_score) }}%</span>
                    </div>
                    {% endif %}
                    {% if analysis.reporting_quality.evidence_score is not none %}
                    <div class="score-item">
                        <h4>Bevis</h4>
                        <div class="score-bar">
                            <div class="score-fill evidence-score"></div>
                        </div>
                        <span class="score-value">{{ "%.1f"|format(analysis.reporting_quality.evidence_score) }}%</span>
                    </div>
                    {% endif %}
                    {% if analysis.reporting_quality.clarity_score is not none %}
                    <div class="score-item">
                        <h4>Tydlighet</h4>
                        <div class="score-bar">
                            <div class="score-fill clarity-score"></div>
                        </div>
                        <span class="score-value">{{ "%.1f"|format(analysis.reporting_quality.clarity_score) }}%</span>
                    </div>
                    {% endif %}
                </div>
                {% if analysis.reporting_quality.overall_quality %}
                <div class="analysis-item">
                    <h4>√ñvergripande kvalitetsbed√∂mning</h4>
                    <p>{{ analysis.reporting_quality.overall_quality }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if analysis.dalio_perspective and analysis.dalio_perspective.cycle_analysis %}
        <div class="analysis-section">
            <h3>Ray Dalio's Perspektiv</h3>
            <div class="dalio-perspective">
                <div class="perspective-item">
                    <h4>Cykelanalys</h4>
                    <p>{{ analysis.dalio_perspective.cycle_analysis }}</p>
                </div>
                <div class="perspective-item">
                    <h4>Identifierade M√∂nster</h4>
                    <p>{{ analysis.dalio_perspective.pattern_identification }}</p>
                </div>
                <div class="perspective-item">
                    <h4>L√•ngsiktiga Implikationer</h4>
                    <p>{{ analysis.dalio_perspective.long_term_implications }}</p>
                </div>
                <div class="perspective-item">
                    <h4>Till√§mpade Principer</h4>
                    <p>{{ analysis.dalio_perspective.principles_applied }}</p>
                </div>
            </div>
            <div class="dalio-note">
                <p>Notera: Detta √§r inte Ray Dalio's direkta √•sikter utan en analys baserad p√• hans publicerade principer och l√§ra.</p>
            </div>
        </div>
        {% endif %}

        {% if analysis.elon_musk_perspective and (analysis.elon_musk_perspective.tech_perspective or analysis.elon_musk_perspective.innovation_potential or analysis.elon_musk_perspective.future_vision or analysis.elon_musk_perspective.practical_application) %}
        <div class="analysis-section">
            <h3>Elon Musk's Perspektiv</h3>
            <div class="musk-perspective">
                {% if analysis.elon_musk_perspective.tech_perspective %}
                <div class="perspective-item">
                    <h4>Teknologisk Synvinkel</h4>
                    <p>{{ analysis.elon_musk_perspective.tech_perspective }}</p>
                </div>
                {% endif %}
                {% if analysis.elon_musk_perspective.innovation_potential %}
                <div class="perspective-item">
                    <h4>Innovationspotential</h4>
                    <p>{{ analysis.elon_musk_perspective.innovation_potential }}</p>
                </div>
                {% endif %}
                {% if analysis.elon_musk_perspective.future_vision %}
                <div class="perspective-item">
                    <h4>Framtidsvision</h4>
                    <p>{{ analysis.elon_musk_perspective.future_vision }}</p>
                </div>
                {% endif %}
                {% if analysis.elon_musk_perspective.practical_application %}
                <div class="perspective-item">
                    <h4>Praktisk Till√§mpning</h4>
                    <p>{{ analysis.elon_musk_perspective.practical_application }}</p>
                </div>
                {% endif %}
            </div>
            <div class="dalio-note">
                <p>Notera: Detta √§r inte Elon Musk's direkta √•sikter utan en analys baserad p√• hans tidigare uttalanden och v√§rderingar.</p>
            </div>
        </div>
        {% endif %}
      </div>
    {% else %}
      <button class="check" data-id="{{ art.id }}">F√• nyanserad bild</button>
    {% endif %}
  </article>
{% endfor %}
</main>

<footer>
  <small>Uppdaterad {{ now.strftime("%Y-%m-%d %H:%M UTC") }} ¬∑ Prototyp</small>
</footer>

<script>
// Add fetch news button handler
document.getElementById('fetchNewsBtn').onclick = async () => {
  const btn = document.getElementById('fetchNewsBtn');
  
  // Add loading state
  btn.disabled = true;
  btn.classList.add('analyzing');
  btn.textContent = 'H√§mtar nyheter...';
  
  try {
    const r = await fetch('/api/fetch-news', {method: 'POST'});
    const j = await r.json();
    
    if (r.status === 429) {
      // Rate limit exceeded - show the message
      btn.textContent = j.message;
      btn.classList.remove('analyzing');
      btn.classList.add('rate-limited');
      // Re-enable the button after 5 seconds
      setTimeout(() => {
        btn.disabled = false;
        btn.classList.remove('rate-limited');
        btn.textContent = 'Uppdatera nyhetsfl√∂det';
      }, 5000);
      return;
    }
    
    if (!r.ok || j.status !== 'ok') { 
      btn.textContent = 'Ett fel uppstod';
      btn.classList.remove('analyzing');
      return; 
    }
    
    // Reload the page to show new articles
    location.reload();
    
  } catch (error) {
    btn.textContent = 'Ett fel uppstod';
    btn.classList.remove('analyzing');
  }
};

// Add reset all button handler
document.getElementById('resetAllBtn').onclick = async () => {
  if (!confirm('√Ñr du s√§ker p√• att du vill ta bort alla nyheter?')) return;
  
  const password = prompt('Ange administrat√∂rsl√∂senord:');
  if (!password) return;
  
  const btn = document.getElementById('resetAllBtn');
  btn.disabled = true;
  btn.textContent = 'Rensar...';
  
  try {
    const r = await fetch('/reset-all', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ password })
    });
    
    if (r.status === 401) {
      alert('Felaktigt l√∂senord');
      btn.textContent = 'Rensa alla nyheter';
      btn.disabled = false;
      return;
    }
    
    if (!r.ok) {
      btn.textContent = 'Ett fel uppstod';
      return;
    }
    
    location.reload();
  } catch (error) {
    btn.textContent = 'Ett fel uppstod';
  }
};

document.addEventListener('click', async e => {
  if (!e.target.matches('button.check')) return;
  const btn = e.target, id = btn.dataset.id;
  
  // Skip if it's the fetch news button
  if (btn.id === 'fetchNewsBtn') return;
  
  // Add loading state
  btn.disabled = true;
  btn.classList.add('analyzing');
  btn.textContent = 'Analyserar...';
  
  try {
    const r = await fetch('/api/analyse', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ article_id: id })
    });
    if (!r.ok) { 
      btn.textContent = 'Ett fel uppstod';
      btn.classList.remove('analyzing');
      return; 
    }
    
    const j = await r.json();
    if (!j.success) { 
      btn.textContent = 'Ett fel uppstod';
      btn.classList.remove('analyzing');
      return; 
    }
    
    // Add loading animation to the card
    const card = btn.closest('.card');
    card.classList.add('loading');
    
    // Reload after a short delay to show the loading animation
    setTimeout(() => location.reload(), 500);
    
  } catch (error) {
    btn.textContent = 'Ett fel uppstod';
    btn.classList.remove('analyzing');
  }
});

// Set score bar widths using CSS variables
document.addEventListener('DOMContentLoaded', () => {
  const analysis = document.querySelector('.analysis');
  if (analysis) {
    // Get all score items
    const scoreItems = analysis.querySelectorAll('.score-item');
    
    scoreItems.forEach(item => {
      const scoreValue = item.querySelector('.score-value');
      const scoreFill = item.querySelector('.score-fill');
      
      if (scoreValue && scoreFill) {
        // Extract the percentage value from the text (remove the % sign)
        const value = parseFloat(scoreValue.textContent);
        if (!isNaN(value)) {
          // Set the CSS variable based on the score type
          const scoreType = scoreFill.classList[1]; // objectivity-score, depth-score, etc.
          const cssVar = scoreType.replace('-score', '');
          document.documentElement.style.setProperty(`--${cssVar}-score`, `${value}%`);
        }
      }
    });
  }
  
  // Add hover effects to cards
  document.querySelectorAll('.card').forEach(card => {
    card.addEventListener('mouseenter', () => {
      card.style.transform = 'translateY(-4px)';
      card.style.boxShadow = '0 8px 32px var(--shadow)';
    });
    
    card.addEventListener('mouseleave', () => {
      card.style.transform = 'translateY(0)';
      card.style.boxShadow = '0 4px 24px var(--shadow)';
    });
  });
});

// Add toggle functionality for analysis sections
function toggleAnalysis(button) {
  const analysis = button.closest('.card').querySelector('.analysis');
  const isCollapsed = analysis.classList.contains('collapsed');
  
  if (isCollapsed) {
    analysis.classList.remove('collapsed');
    button.textContent = 'D√∂lj analys';
  } else {
    analysis.classList.add('collapsed');
    button.textContent = 'Visa analys';
  }
}
</script>

<style>
/* Add styles for rate-limited state */
#fetchNewsBtn.rate-limited {
  background: #ff9800;
  color: white;
  cursor: not-allowed;
}

#fetchNewsBtn.rate-limited:hover {
  background: #ff9800;
  transform: none;
}
</style>
</body>
</html>
